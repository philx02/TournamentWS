<!DOCTYPE html>
<html>
<head>
<style>
  
h1
{
  font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
}

#title_table table, tr, td, th
{
  padding: 0 0 0 0;
}

#title_table td.disc
{
  padding: 0 0 0 200px;
}

#result_table
{
  background: white;
  border-radius: 10px;
  font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
  text-align: center;
  border: 1px solid black;
  table-layout: fixed;
}

#leader_board_table
{
  background: white;
  border-radius: 10px;
  font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
  text-align: left;
  table-layout: fixed;
}

#leader_board_table td, th
{
  text-align: left;
  padding: 3px 7px 2px 7px;
  width: 100px;
}
  
#leader_board_table td.rank
{
  width: 10px;
}
  
#leader_board_table td.score
{
  width: 10px;
}

#result_table td, th
{
  text-align: center;
  border: 1px solid black;
  padding: 3px 7px 2px 7px;
  width: 100px;
}

#result_table td.names
{
  text-align: left;
}

#result_table td.invalid
{
  background-color: black;
}

#result_table td.victory
{
  background-color: #CCFB5D;
}

#result_table td.defeat
{
  background-color: #EDDA74;
}

#result_table td.unfinished
{
  vertical-align: center;
  padding: 0 0 0 0;
}

#edit_result
{
  cursor: pointer;
  cursor: hand;
}

#result_table td.score
{
  font-weight: bold;
}

#report_result_table
{
  font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
}
#report_result_table th, td
{
  font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
  border: 0;
  text-align: center;
}

input
{
  text-align: center;
}

#result_submission_div
{
  width:100%;
  height:100%;
  opacity:1;
  top:0;
  left:0;
  display:none;
  position:fixed;
  background-image:url(transpBlack50.png);
  overflow:auto
}

img#close {
position:absolute;
right:-14px;
top:-14px;
cursor:pointer
}

div#popup_result {
position:absolute;
left:50%;
top:17%;
margin-left:-300px;
  font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
}
form {
max-width:500px;
min-width:250px;
padding:10px 50px;
border:2px solid gray;
border-radius:10px;
font-family:raleway;
background-color:#fff
}
h2 {
  font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
background-color:#FEFFED;
padding:20px 35px;
margin:-10px -50px;
text-align:center;
border-radius:10px 10px 0 0
}
hr {
margin:10px -50px;
border:0;
border-top:1px solid #ccc
}
#submit {
  
  font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
text-decoration:none;
width:100%;
text-align:center;
display:block;
background-color:#FFBC00;
color:#fff;
border:1px solid #FFCB00;
padding:10px 0;
font-size:20px;
cursor:pointer;
border-radius:5px
}

</style>  
</head>
 
<body onload="startup()">

<script src="jquery.js"></script>

<script>

var QueryString = function () {
  // This function is anonymous, is executed immediately and 
  // the return value is assigned to QueryString!
  var query_string = {};
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i = 0; i < vars.length; i++) {
    var pair = vars[i].split("=");
    // If first entry with this name
    if (typeof query_string[pair[0]] === "undefined") {
      query_string[pair[0]] = pair[1];
      // If second entry with this name
    } else if (typeof query_string[pair[0]] === "string") {
      var arr = [query_string[pair[0]], pair[1]];
      query_string[pair[0]] = arr;
      // If third or later entry with this name
    } else {
      query_string[pair[0]].push(pair[1]);
    }
  }
  return query_string;
}();

var wWebSocket;

$(document).on('keydown', function (e)
{
  if (e.keyCode === 27) // ESC
  {
    div_hide();
  }
});

function startup()
{
  connect();
}

function connect()
{
  try
  {
    wWebSocket = new WebSocket(QueryString.server);
  }
  catch (exc)
  {
    document.getElementById("debug").innerHTML = exc.message;
  }
  wWebSocket.onopen = function (evt) { greetings(); };
  wWebSocket.onmessage = function (evt) { updateTable(evt); };
  wWebSocket.onerror = function (evt) { try_reconnect(evt); };
  wWebSocket.onclose = function (evt) { try_reconnect(evt); };
}

function try_reconnect(evt)
{
  if (wWebSocket.readyState != 0 && wWebSocket.readyState != 1)
  {
    document.getElementById("disconnect_image").innerHTML = "<img src='disconnected-128.png' height='40' width='40'/>";
    connect();
    setTimeout(try_reconnect, 5000, evt);
  }
}

function greetings()
{
  wWebSocket.send("get|" + QueryString.id);
}

function updateTable(evt)
{
  document.getElementById("disconnect_image").innerHTML = "";
  //document.getElementById("debug").innerText = evt.data;
  var wSplit = evt.data.split("|");
  document.getElementById("tournament_name").innerHTML = wSplit[0];
  document.title = wSplit[0];
  var wPlayersCouple = wSplit[1].split(";");
  wPlayersCouple.pop();
  var wTable = wSplit[2].split(";");
  var wHtml = "<table id='result_table'>";
  wHtml += "<tr><th></th>";
  var wPlayerIds = [];
  for (i = 0; i < wPlayersCouple.length; ++i)
  {
    var wPlayerSplit = wPlayersCouple[i].split(",");
    wHtml += "<th>" + wPlayerSplit[1] + "</th>";
    wPlayerIds.push({ id: wPlayerSplit[0], name: wPlayerSplit[1] });
  }
  for (i = 0; i < wPlayersCouple.length; ++i)
  {
    var wPlayerSplit = wPlayersCouple[i].split(",");
    wHtml += "<tr><td class='names'>" + wPlayerSplit[1] + "</td>"
    var wRow = wTable[i].split(",");
    for (j = 0; j < wPlayersCouple.length; ++j)
    {
      if (i != j)
      {
        wResult = (wRow[j] == "") ? "<img id='edit_result' onclick='submitResult(" + wPlayerIds[j].id + ", \"" + wPlayerIds[j].name + "\", " + wPlayerIds[i].id + ", \"" + wPlayerIds[i].name + "\")' src='edit.png' height='20' width='20'/>" : wRow[j];
        wHtml += "<td class='" + (wResult[0] == "2" ? "victory" : wResult[4] == "2" ? "defeat" : "unfinished") + "'>" + wResult + "</td>";
      }
      else
      {
        wHtml += "<td class='invalid'>&nbsp;</td>";
      }
    }
  }
  wHtml += "</tr>";
  wHtml += "<tr>";
  wHtml += "<td class='score'>Score</td>"
  var wPlayersScores = wSplit[3].split(";");
  wPlayersScores.pop();
  for (i = 0; i < wPlayersScores.length; ++i)
  {
  	wHtml += "<td>" + wPlayersScores[i] + "</td>";
  }
  wHtml += "</tr>";
  wHtml += "</table>";
  document.getElementById("tournament_table").innerHTML = wHtml;

  var wLeaderboardComment = (wSplit[4] != 0) ? (wSplit[4] + " matches to go") : "Final";
  document.getElementById("leaderboard_title").innerHTML = "Leaderboard (" + wLeaderboardComment + ")";

  wHtml = "<table id='leader_board_table'>";
  var wLeaderBoard = wSplit[5].split(";");
  wLeaderBoard.pop();
  for (i = 0; i < wLeaderBoard.length; ++i)
  {
    var wPlayerScore = wLeaderBoard[i].split(",");
    wHtml += "<tr><td class='rank'>" + (i + 1) + "</td><td>" + wPlayerScore[0] + "</td><td class='score'>" + wPlayerScore[1] + "</td><td>(" + wPlayerScore[2] + ")</td></tr>";
  }
  wHtml += "</table>";
  document.getElementById("leader_board").innerHTML = wHtml;
}

function submitResult(iPlayer1Id, iPlayer1Name, iPlayer2Id, iPlayer2Name)
{
  document.getElementById("form_player1_id").value = iPlayer1Id;
  document.getElementById("form_player1_name").innerHTML = iPlayer1Name;
  document.getElementById("form_player2_id").value = iPlayer2Id;
  document.getElementById("form_player2_name").innerHTML = iPlayer2Name;
  document.getElementById("form").reset();
  div_show();
  document.getElementById("form_score1").focus();
}

function div_show()
{
  document.getElementById('result_submission_div').style.display = "block";
}

function div_hide()
{
  document.getElementById('result_submission_div').style.display = "none";
}

function submit_result()
{
  var wScorePlayer1 = parseInt(document.getElementById("form_score1").value);
  var wScorePlayer2 = parseInt(document.getElementById("form_score2").value);
  if (wScorePlayer1 + wScorePlayer2 > 3 || wScorePlayer1 != 2 && wScorePlayer2 != 2)
  {
    alert("error");
    return;
  }
  div_hide();
  var wSubmission = "submit|" + QueryString.id + "|";
  wSubmission += document.getElementById("form_player1_id").value + ";";
  wSubmission += document.getElementById("form_score1").value + ";";
  wSubmission += document.getElementById("form_player2_id").value + ";";
  wSubmission += document.getElementById("form_score2").value;
  wWebSocket.send(wSubmission);
  greetings();
}

</script>
  
<div id="result_submission_div">
  <div id="popup_result">
  <form action="#" id="form" method="post" name="form">
    <input id="form_player1_id" type="hidden" />
    <input id="form_player2_id" type="hidden" />
    <h2>Report Result</h2>
    <hr/>
    <table id="report_result_table">
      <tr><th id="form_player1_name"></th><th>VS</th><th id="form_player2_name"></th></tr>
      <tr><td><input id="form_score1" class="input_form_score" type="text" maxlength="1" size="3" name="form_score1"/></td><td/><td><input id="form_score2" class="input_form_score" type="text" maxlength="1" size="3" name="form_score1"/></td></tr>
    </table>
  <p><a href="javascript:%20submit_result()" id="submit">Submit</a></p>
  </form>
  </div>
</div>
  
  <!--
<button onclick='div_show()'>Report Result</button>
  -->
  
<!-- <p id="debug"></p> -->

<table id="title_table">
  <tr>
    <td><h1 id="tournament_name"></h1></td>
    <td id="disconnect_image" class="disc"></td>
  </tr>
</table>

<p id="tournament_table"></p>

<h1 id="leaderboard_title"></h1>
<p id="leader_board"></p>

</body>
</html> 
